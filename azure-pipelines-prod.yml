trigger: none

parameters:
  - name: imageVersion
    displayName: 'Versi√≥n de imagen (ej: v1.0.10)'
    type: string

pool:
  vmImage: 'ubuntu-latest'

steps:
  - task: AzureCLI@2
    displayName: 'Build & push imagen a ACR'
    inputs:
      azureSubscription: 'Microsoft Azure Sponsorship'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az acr build \
          --registry nav29acr \
          --image nav29-server:latest \
          --image nav29-server:${{ parameters.imageVersion }} \
          .
      workingDirectory: '$(Build.SourcesDirectory)'

  - task: AzureCLI@2
    displayName: 'Deploy a Container App (prod)'
    inputs:
      azureSubscription: 'Microsoft Azure Sponsorship'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az extension add --name containerapp --upgrade --yes
        az containerapp update \
          --name nav29-server \
          --resource-group nav29 \
          --image nav29acr.azurecr.io/nav29-server:${{ parameters.imageVersion }}
